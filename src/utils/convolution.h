#ifndef FTEST_H

#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <stdio.h>
#include <stddef.h>

#include <fdist.h>

#include "simd.h"
#include "readout.h" //for the "peak_t" struct

#ifndef KVPAIR
#define KVPAIR
typedef union {
    uint64_t data; // The raw 64-bit representation
    struct {
        uint16_t key;        // 16-bit key
        uint16_t idx; // 16-bit index
        float val;         // 32-bit floating-point value
    } parts;
} kvpair;
#endif

static constexpr double corr[256] =
{0.2345679012345679, 0.136, 0.09620991253644315, 0.0745313214449017,
0.06085649887302779, 0.051433773327264454, 0.04454320987654321, 0.039283533482597194,
0.03513631724741216, 0.03178202497930389, 0.029012903756061477, 0.026688,
0.02470829311249979, 0.023002173110828653, 0.021516565405659428, 0.020211295693389357,
0.01905539358600583, 0.01802459874044973, 0.017099636429024987, 0.016264999056891223,
0.015508068471958444, 0.014818472793781436, 0.01418760775550697, 0.013608275463454852,
0.013074408284395394, 0.012580855336956012, 0.012123215627347859, 0.011697706356791744,
0.011301058043909065, 0.010930430300333508, 0.010583343664724364, 0.010257624032771962,
0.009951357048573129, 0.009662850434336146, 0.009390602691730626, 0.009133276951906986,
0.00888967901234568, 0.008658738798728678, 0.008439494644439893, 0.008231079900371505,
0.00803271148172309, 0.00784368003256666, 0.007663341447697782, 0.007491109538149904,
0.0073264496643315625, 0.00716887319104991, 0.007017932643242455, 0.006873217461237486,
0.00673435027072411, 0.00660098359605591, 0.006472796956604898, 0.006349494295072527,
0.006230801694307874, 0.006116465345563689, 0.00600624973646644, 0.005899936031470022,
0.00579732062135284, 0.005698213821524509, 0.005602438701629935, 0.005509830031254922,
0.005420233328514791, 0.005333504, 0.00524950656200525, 0.005168113934218386,
0.005089206798123386, 0.005012673013303795, 0.004938407085640739, 0.004866309682101212,
0.0047962871874230855, 0.004728251298535982, 0.0046621186530228535, 0.004597810488334905,
0.004535252328830401, 0.0044743736980225515, 0.004415107853698761, 0.004357391543818082,
0.004301164781309792, 0.004246370636087354, 0.0041929550427617064, 0.00414086662268848,
0.004090056519117834, 0.004040478244334994, 0.003992087537786129, 0.0039448422342794175,
0.0038987021414362984, 0.0038536289256442557, 0.0038095860058309037, 0.003766538454440658,
0.0037244529050505996, 0.0036832974661119263, 0.0036430416403483165, 0.0036036562493830574,
0.003565113363203436, 0.0035273862341040378, 0.003490449234780609, 0.003454277800273388,
0.003418848373483482, 0.0033841383540083652, 0.003350126050062946, 0.003316790633271273,
0.0032841120961308967, 0.003252071211967325, 0.0032206494972101597, 0.0031898291758353766,
0.0031595931458300044, 0.0031299249475462746, 0.003100808733822179, 0.003072229241754485,
0.0030441717660185403, 0.0030166221336368885, 0.0029895666801057247, 0.0029629922267946957,
0.002936886059541511, 0.0029112359083683062, 0.0028860299282517754, 0.002861256680883749,
0.002836905117363205, 0.0028129645617646906, 0.0027894246955318153, 0.002766275542647873,
0.002743507455538832, 0.0027211111016668225, 0.002699077450775, 0.002677397762747144,
0.0026560635760477084, 0.002635066696710202, 0.0026143991878437908, 0.002594053359629889,
0.002574021759782258, 0.002554297164445739, 0.002534872569510276, 0.0025157411823182895,
0.002496896413744767, 0.0024783318706306755, 0.0024600413485514464, 0.00244201882490334,
0.00242425845229151, 0.002406754552204526, 0.0023895016089609616, 0.0023724942639145115,
0.0023557273099048333, 0.0023391956859420532, 0.002322894472113528, 0.002306818884702101,
0.0022909642715056777, 0.0022753261073484967, 0.0022598999897750012, 0.002244681634917703,
0.0022296668735308904, 0.0022148516471824677, 0.002200232004596619, 0.002185804098140373,
0.0021715641804475033, 0.0021575086011735483, 0.0021436338038760406, 0.002129936323014351,
0.0021164127810638267, 0.002103059885739177, 0.002089874427322315, 0.0020768532760900922,
0.002063993379837604, 0.002051291761492945, 0.002038745516819496, 0.002026351812202024,
0.002014107882513048, 0.002002011029056092, 0.001990058617582615, 0.001978248076379559,
0.001966576894424597, 0.0019550426196062974, 0.0019436428570065618, 0.001932375267242805,
0.0019212375648674667, 0.0019102275168225574, 0.0018993429409470406, 0.001888581704534958,
0.0018779417229422956, 0.0018674209582406772, 0.0018570174179160627, 0.001846729153610706,
0.0018365542599066969, 0.0018264908731495024, 0.0018165371703099743, 0.0018066913678833642,
0.0017969517208239545, 0.0017873165215139607, 0.0017777840987654322, 0.0017683528168539236,
0.0017590210745827616, 0.0017497873043767862, 0.0017406499714044848, 0.0017316075727274918,
0.0017226586364764585, 0.001713801721052349, 0.0017050354143522456, 0.0016963583330188003,
0.0016877691217124812, 0.001679266452405822, 0.0016708490236988967, 0.0016625155601552768,
0.0016542648116577656, 0.001646095552783219, 0.0016380065821958016, 0.001629996722058044,
0.001622064817459097, 0.0016142097358595956, 0.00160643036655258, 0.001598725620139926,
0.001591094428023773, 0.001583535741912447, 0.0015760485333404012, 0.0015686317932017098,
0.0015612845312966755, 0.0015540057758911166, 0.0015467945732879252, 0.001539649987410501,
0.0015325710993976743, 0.0015255570072097557, 0.0015186068252453513, 0.0015117196839686074,
0.0015048947295465509, 0.0014981311234962104, 0.0014914280423412114, 0.0014847846772775468,
0.0014782002338482444, 0.0014716739316266486, 0.001465205003908059, 0.0014587926974094642,
0.001452436271977124, 0.0014461350003017693, 0.001439888167641176, 0.0014336950715499047,
0.001427555021615981, 0.0014214673392043166, 0.0014154313572066638, 0.0014094464197979175,
0.0014035118821985712, 0.0013976271104431505, 0.0013917914811544469, 0.001386004381323385,
0.001380265208094359, 0.0013745733685558792, 0.001368928279536379, 0.0013633293674050306,
0.0013577760678774324, 0.0013522678258260214, 0.0013468040950950857, 0.0013413843383202429,
0.0013360080267522567, 0.001330674640085078, 0.0013253836662879851, 0.0013201346014417145,
0.0013149269495784691, 0.0013097602225256993, 0.0013046339397535529, 0.0012995476282258913};

static inline void sortPeaks(peak_t *peaks, int length) {
    int i, j;
    peak_t key;

    for (i = 1; i < length; i++) {
        key = peaks[i];
        j = i - 1;
        while (j >= 0 && peaks[j].chi2 > key.chi2) {
            peaks[j + 1] = peaks[j];
            j = j - 1;
        }
        peaks[j + 1] = key;
    }
}


static inline int32_t wrapidx(int32_t idx, int32_t n){
        while (idx >= n) {idx -=n;}
return idx;}

// Extract key from the 64-bit value (16-bit key at the lower 16 bits)
static inline uint16_t extract_key(uint64_t value) { return (uint16_t) value;} // Assuming lowest 16 bits only on little endian

static inline void bsort64_10(uint64_t** array, size_t n, uint64_t* aux_buffer, size_t* indices) {
    // Clear the indices array (initialized to 0)
    memset(indices, 0, 1024 * sizeof(size_t));

    // Compute the bin sizes (counting phase)
    for (size_t i = 0; i < n; i++) {size_t index_tmp = extract_key((*array)[i]); indices[index_tmp] += 1;}

    // Compute the first index of each bin (prefix sum phase)
    //to be vectorized - https://stackoverflow.com/questions/69694914/accumulating-a-running-total-prefix-sum-horizontally-across-an-m256i-vector
    for (size_t i = 1; i < 1024; i++) {indices[i] += indices[i - 1];}

    // Rearrange elements into the aux_buffer based on indices (placement phase)
    for (size_t i = 0; i < n; i++) {
        uint16_t index_tmp = extract_key((*array)[i]);
        size_t pos = --indices[index_tmp];  // Decrease the position before placing the element
        (aux_buffer)[pos] = (*array)[i];
    }

    // Swap the pointers
    uint64_t* tmp = aux_buffer;
    aux_buffer = *array;
    *array = tmp;
}












































#define FTEST_H
#endif
